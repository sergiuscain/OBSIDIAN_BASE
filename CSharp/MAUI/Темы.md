Как добавить смену тем в MAUI приложении

Создаем в папке Resources/Themes ResourcesDictionary.xaml файл для каждой темы, в которой будут храниться цвета тем:

Темная тема:
``` xaml
<?xml version="1.0" encoding="utf-8" ?>
<ResourceDictionary xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Sigma_Trainer.Resources.Themes.DarkTheme">
    <Color x:Key="PrimaryColor">#121212</Color>
    <Color x:Key="SecondaryColor">#1E1E1E</Color>
    <Color x:Key="TextColor">#FFFFFF</Color>
    <Color x:Key="TextColor2">#B0B0B0</Color>
    <Color x:Key="PlaceholderColor">#B0B0B0</Color>
    <Color x:Key="BorderColor">#3c3c3c</Color>
</ResourceDictionary>
```
Светлая тема:
``` xaml
<?xml version="1.0" encoding="utf-8" ?>
<ResourceDictionary xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Sigma_Trainer.Resources.Themes.LightTheme">
    <Color x:Key="PrimaryColor">#FFFFFF</Color>
    <Color x:Key="SecondaryColor">#F0F0F0</Color>
    <Color x:Key="TextColor">#000000</Color>
    <Color x:Key="TextColor2">#555555</Color>
    <Color x:Key="PlaceholderColor">#AAAAAA</Color>
    <Color x:Key="BorderColor">#CCCCCC</Color>
</ResourceDictionary>
```
Создаем сервис для работы с сменой тем, например SettingsService
И добавляем его в [[Зависимости (Di)]]
``` c#
using Newtonsoft.Json;
using Sigma_Trainer.Model;
using Sigma_Trainer.Resources.Themes;

namespace Sigma_Trainer.Services
{
    public class SettingsService
    {
        /// <summary>
        /// Путь к файлу с настройками
        /// </summary>
        private readonly string _settingsFilePath;
        private AppSettings _appSettings;
        public SettingsService()
        {
            _settingsFilePath = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData), "settings.json");
            LoadOrCreateSettingsAsync().Wait();
        }
        /// <summary>
        /// Загружает в _appSettings данные из файла с настройками или создает новый файл
        /// </summary>
        private async Task LoadOrCreateSettingsAsync()
        {
            if (File.Exists(_settingsFilePath))
            {
                LoadSettings();
            }
            else
            {
                _appSettings = new AppSettings { SelectedTheme = ThemesEnum.Темная.ToString()};
                await SaveSettingsAsync();
            }
        }
        private void LoadSettings()
        {
            var json = File.ReadAllText(_settingsFilePath);
            _appSettings = JsonConvert.DeserializeObject<AppSettings>(json);
        }
        /// <summary>
        /// Записываает настройки из _appSettings в файл
        /// </summary>
        private async Task SaveSettingsAsync()
        {
            var json = JsonConvert.SerializeObject(_appSettings);
            await File.WriteAllTextAsync(_settingsFilePath, json);
        }
        /// <summary>
        /// Сохраняем в настройках выбранную тему
        /// </summary>
        /// <param name="theme"></param>
        /// <returns></returns>
        public async Task SetThemeAsync(string theme)
        {
            _appSettings.SelectedTheme = theme;
            await SaveSettingsAsync();
        }
        /// <summary>
        /// Загружаем тему в самом приложении и применяем её
        /// </summary>
        /// <param name="selectedTheme"></param>
        public void LoadTheme(string selectedTheme)
        {

            // Удаляем все текущие темы
            Application.Current.Resources.MergedDictionaries.Clear();

            if (selectedTheme == ThemesEnum.Светлая.ToString())
            {
                Application.Current.Resources.MergedDictionaries.Add(new LightTheme());
            }
            else if (selectedTheme == ThemesEnum.Темная.ToString())
            {
                Application.Current.Resources.MergedDictionaries.Add(new DarkTheme());
            }
        }
        /// <summary>
        /// Применяем выбранную тему.
        /// </summary>
        /// <returns></returns>
        public async Task LoadTheme()
        {
            LoadTheme(_appSettings.SelectedTheme);
        }
        /// <summary>
        /// Получаем текущую тему
        /// </summary>
        /// <returns></returns>
        public string GetTheme()
        {
            LoadSettings();
            return _appSettings.SelectedTheme;
        }
        public void SetTheme(string theme)
        {
            _appSettings.SelectedTheme = theme;
            var json = JsonConvert.SerializeObject(_appSettings);
            File.WriteAllText(_settingsFilePath, json);
        }
    }
}

```
Не забудьте добавить NuGet пакет: NewtonsoftJson и директорию тем 
using Sigma_Trainer.Resources.Themes;

Создаем страницу для настроек типа ContentPage, если её нету SettingsPage.xaml:
```xaml
<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodel="clr-namespace:Sigma_Trainer.ViewModel"
             x:DataType="viewmodel:SettingsViewModel"
             x:Class="Sigma_Trainer.View.SettingsPage"
             Title="Настройки">
    <VerticalStackLayout>
        <Picker ItemsSource="{Binding Themes}" 
            SelectedItem="{Binding SelectedTheme}" 
            Title="Выбор темы" />
    </VerticalStackLayout>
</ContentPage>
```
И обязательно привязываем к ней Модель представления (Создаем новый частичный класс): SettingsViewModel и наследуемся от ObservableObject из NuGett библиотеки CommunityToolkit.Mvvm
Страницу и её модель представления добавляем в [[Зависимости (Di)]] 
``` c#
using CommunityToolkit.Mvvm.ComponentModel;

namespace Sigma_Trainer.ViewModel
{
    public partial class SettingsViewModel : ObservableObject
    {
		//Здесь будет добавлен код на следующих шагах
    }
}
```
Во второй части частичного класса SettingsPage.xaml (SettingsPage.xaml.cs) добавляем привязку к модели представления:
``` c#
using Sigma_Trainer.ViewModel;

namespace Sigma_Trainer.View;

public partial class SettingsPage : ContentPage
{
	public SettingsPage(SettingsViewModel viewModel)
	{
		BindingContext = viewModel;
		InitializeComponent();
	}
}
```

Добавьте возможность попасть на вкладку настроек.
Например, через AppShell:
``` xaml
<?xml version="1.0" encoding="UTF-8" ?>
<Shell
    x:Class="SigmaWord.AppShell"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:local="clr-namespace:SigmaWord"
    xmlns:views="clr-namespace:SigmaWord.Views"
    Shell.FlyoutBehavior="Disabled"
    Title="SigmaWord"
    Style="{StaticResource DarkTabBarStyle}">

    <TabBar>
        <Tab Title="УЧИТЬ">
            <ShellContent ContentTemplate="{DataTemplate views:TeachPage}" />
        </Tab>
        <Tab Title="СЛОВАРЬ"
             Icon="Dictionary">
            <ShellContent ContentTemplate="{DataTemplate views:DictionaryPage}"/>
        </Tab>
        <Tab Title="НАСТРОЙКИ"
            Icon="dog.png">
            <ShellContent ContentTemplate="{DataTemplate views:SettingsPage}" />
        </Tab>
    </TabBar>

</Shell>
```
Или так:
``` xaml
<?xml version="1.0" encoding="UTF-8" ?>
<Shell
    x:Class="Sigma_Trainer.AppShell"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:local="clr-namespace:Sigma_Trainer.View"
    Shell.FlyoutBehavior="Flyout">

    <ShellContent
        Title="Сводка"
        ContentTemplate="{DataTemplate local:SummaryPage}"
        Route="MainPage" />
    <ShellContent
        Title="Тренировки"
        ContentTemplate="{DataTemplate local:WorkoutPage}"
        Route="WorkoutPage"/>
    <ShellContent
        Title="Питание"
        ContentTemplate="{DataTemplate local:NutritionPage}"
        Route="NutritionPage"/>
    <ShellContent
        Title="Настройки"
        ContentTemplate="{DataTemplate local:SettingsPage}"
        Route="SettingsPage"/>
</Shell>
```
В классе App в конструкторе добавляем подписку на событие:
``` c#
        public App(DbService dbService)
        {
            InitializeComponent();
            Application.Current.RequestedThemeChanged += OnRequestedThemeChanged;
            MainPage = new AppShell();
        }
```
И метод:
``` c#
        private void OnRequestedThemeChanged(object sender, AppThemeChangedEventArgs e)
        {
            var settingsService = new SettingsService();
            var selectedTheme = settingsService.GetTheme();
            ApplyTheme(selectedTheme); // Применяем сохранённую тему, а не системную
        }
```
И метод:
``` c#
public void ApplyTheme(string selectedTheme)
{
    // Очищаем все текущие темы
    Application.Current.Resources.MergedDictionaries.Clear();

    // Применяем выбранную тему
    switch (selectedTheme)
    {
        case "Светлая":
            Application.Current.Resources.MergedDictionaries.Add(new LightTheme());
            break;
        case "Темная":
            Application.Current.Resources.MergedDictionaries.Add(new DarkTheme());
            break;
    }
}
```
Для применения темы при запуске переопределяем метод OnStart:
``` c#
        protected override async void OnStart()
        {
            // Загружаем тему при запуске приложения
            var settingsService = new SettingsService();
            var selectedTheme = settingsService.GetTheme();
            ApplyTheme(selectedTheme); // Применяем тему ко всему приложению
        }
```
В SettingsViewModel добавляем метод OnSelectedThemeChanged:
И свойства Themes и selectedTheme
``` c#
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Sigma_Trainer.Services;

namespace Sigma_Trainer.ViewModel
{
    public partial class SettingsViewModel : ObservableObject
    {
        public List<string> Themes { get; }
        [ObservableProperty]
        private string selectedTheme;
        public SettingsViewModel()
        {
            Themes = new List<string> { "Светлая", "Темная" };
        }
        [RelayCommand]
        partial void OnSelectedThemeChanged(string selectedTheme)
        {
            var settingsService = new SettingsService();
            settingsService.SetTheme(selectedTheme); // Сохраняем тему в настройках
            ((App)Application.Current).ApplyTheme(selectedTheme); // Применяем тему ко всему приложению
        }
    }
}
```
После этого, в каждой вкладке добавляем динамические ресурсы, которые будут меняться в зависимости от выбранной темы:
```xaml
<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:lvc="clr-namespace:LiveChartsCore.SkiaSharpView.Maui;assembly=LiveChartsCore.SkiaSharpView.Maui"
             xmlns:viewmodel="clr-namespace:Sigma_Trainer.ViewModel"
             xmlns:entities="clr-namespace:DBLibrary.Entities;assembly=DBLibrary"
             x:DataType="viewmodel:WorkoutViewModel"
             x:Class="Sigma_Trainer.View.WorkoutPage"
             Title="Тренировки">
    <ScrollView>
        <VerticalStackLayout BackgroundColor="{DynamicResource PrimaryColor}" Padding="20">
            <Button Text="Создать упражнения" Command="{Binding AddExerciseCommand}" BackgroundColor="{DynamicResource BorderColor}" TextColor="{DynamicResource TextColor}"/>
            <CollectionView ItemsSource="{Binding Exercises}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="entities:Exercises">
                        <VerticalStackLayout>
                            <Label Text="{Binding Name}" TextColor="{DynamicResource TextColor}"/>
                            <Label Text="{Binding Description}" TextColor="{DynamicResource TextColor}"/>
                            <Button Text="Добавить счёт"
                                    Command="{Binding Path=BindingContext.AddScoreCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                    CommandParameter="{Binding Id}"
                                    BackgroundColor="{DynamicResource BorderColor}"
                                    TextColor="{DynamicResource TextColor}"/>
                        </VerticalStackLayout>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
            <Frame>
                <lvc:CartesianChart Series="{Binding Series}" 
                                    XAxes="{Binding XAxes}" 
                                    YAxes="{Binding YAxes}"
                                    HeightRequest="300" 
                                    VerticalOptions="Start"/>
            </Frame>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
```